@using System.Security.Claims
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model List<CommentViewModel>

<div class="comments-section mt-5">
    <h4 class="mb-4">Yorumlar (@Model.Count)</h4>

    @if (User.Identity.IsAuthenticated)
    {
        <div class="add-comment mb-4">
            <form asp-controller="Comment" asp-action="Create" method="post" id="commentForm">
                <input type="hidden" name="BlogId" value="@ViewBag.BlogId" />
                <div class="form-group mb-2">
                    <label for="Content" class="form-label fw-medium text-brown">Yorumunuz</label>
                    <textarea class="form-control rounded-3 border-amber-dark" name="Content" id="Content" rows="3"
                              placeholder="Yorumunuzu yazın..."></textarea>
                    <span class="text-danger small" data-valmsg-for="Content"></span>
                </div>
                <button type="submit" class="btn btn-amber rounded-3 mt-2">Yorum Ekle</button>
            </form>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            Yorum yapmak için <a asp-controller="Auth" asp-action="Login">giriş yapın</a>.
        </div>
    }

    <div id="commentsList">
        @foreach (var comment in Model)
        {
            <div class="comment-item mb-3 p-3 border-bottom" id="comment-@comment.Id">
                <div class="d-flex">
                    <img src="@comment.UserProfilePhotoUrl" class="rounded-circle me-2" width="40" height="40"  alt=""/>
                    <div>
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-0">@comment.UserName</h6>
                            <small class="text-muted">@comment.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                        </div>
                        <p class="mb-1">@comment.Content</p>

                        @if (User.Identity.IsAuthenticated && Guid.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier)) == comment.UserId) {
                            <form asp-controller="Comment" asp-action="Delete" method="post"
                                  onsubmit="return confirm('Yorumu silmek istediğinize emin misiniz?');">
                                <input type="hidden" name="id" value="@comment.Id" />
                                <input type="hidden" name="blogId" value="@comment.BlogId" />
                                <button type="submit" class="btn btn-sm text-danger p-0 bg-transparent border-0">Sil</button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>